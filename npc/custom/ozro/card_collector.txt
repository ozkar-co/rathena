//===== Hercules Script ======================================
//= Card Collector
//===== By: ==================================================
//= Ozcodex
//===== Current Version: =====================================
//= 4.2
//===== Description: =========================================
//= An investigator who travels the world collecting cards
//= with their team, documenting every card's power and origin.
//===== Additional Comments: =================================
//= 1.0 Initial script - dialog only
//= 1.1 Added card helper registration and inventory checking
//= 2.0 Full card tracking system with progress, missing, and collection view
//= 2.1 Fixed variable length issue by splitting storage by category
//= 2.2 Fixed infinite loop for returning players - added dialogue clear
//= 3.0 Complete refactor - removed infinite loops, simplified menu flow
//=     Removed all color codes and decorators, menu executes once then exits
//= 3.1 Fixed infinite loop in Register Cards and Check Progress options
//=     - Added missing close statement after switch block
//=     - Removed trailing next statements that blocked dialogue flow
//= 3.2 Fixed card registration and detection issues
//=     - AddCardToCategory now initializes variables with "|" prefix
//=     - This ensures strpos() correctly finds cards in format "|ID1|ID2|"
//=     - RegCardsInv now shows message even when no cards found
//=     - Added MigrateOldFormat to fix existing data from old format
//= 3.3 Refactored to separate data operations from UI
//=     - Functions now return data instead of displaying dialogs
//=     - RegCardsInv returns card counts via @reg_total and @reg_new
//=     - ShowProgress builds progress strings in @progress_line1$ through @progress_line10$
//=     - All dialog display happens in main menu after switch
//=     - Added debugmes statements for troubleshooting
//=     - Changed Cecil Damond Card (4368) from S to C
//= 4.0 Prepared data via direct lookup table and debug-only scan
//=     - Replaced setarray category lists with precomputed setd mapping .card_cat_<ID>$
//=     - Added interaction that scans inventory and logs card -> category via debugmes
//=     - No runtime loops for category resolution; lookups are O(1) via getd()
//= 4.1 Complete UI/UX refinement and interaction flow enhancement
//=     - Implemented persistent data storage via account variables (#CARD_SEEN_*, #CARD_CT_*)
//=     - Built interactive menu system with 5 primary actions
//=     - Added two-page progress display: summary (total %) + category breakdown
//=     - Separated "Explorar" and "Ver faltantes" into direct-access options
//=     - Enhanced visualization with percentage calculations per category
//=     - Removed formatting clutter for cleaner narrative presentation
//= 4.2 Optimized card database maintenance
//=     - Card-to-category mapping now generated dynamically from card_arr_X[] arrays
//=     - Single source of truth: any card change only requires array modification
//=     - Eliminated 550+ redundant setd() declarations (~530 lines reduced to ~12)
//=     - Moving cards between categories now requires changing only one array location
//============================================================

// Global function: Get card category by ID
// Returns: "A", "B", ... "MVP", "BOSS" or "" if not found
function	script	GetCardCategory	{
	.@id = getarg(0);
	.@cat$ = getd(".card_cat_" + .@id + "$");
	return .@cat$;
}
-	script	Card Collector	FAKE_NPC,{
	mes .npc_name$;
	mes "Soy parte de la Iniciativa de Archivo Arcano, un pequeno escuadron que recorre los rincones del mundo recolectando el saber que habita en cada carta.";
	next;
	mes .npc_name$;
	mes "Las cartas no son simples objetos... guardan los secretos de los monstruos que las portan. Cada una tiene una historia que contar.";
	next;
	mes .npc_name$;
	mes "Se nota que has pasado por muchas mazmorras... Podrias ayudarnos a completar nuestro Archivo?";
	next;
	switch(select ("Claro, es un honor ayudar", "Quizas despues")){
		case 1:
			mes .npc_name$;
			mes "Excelente aventurero. Cada carta registrada es una victoria contra el olvido.";
			mes "Solo necesito tu permiso para documentar tus hallazgos.";
			next;
			break;
		case 2:
			mes .npc_name$;
			mes "Comprendo. Cuando el camino te canse, vuelve. El Archivo siempre estara aqui.";
			close;

	}

	switch(select("Registrar mis cartas", "Ver mi progreso", "Explorar mi coleccion", "Ver cartas faltantes", "Despedirse")) {
		case 1:
			callsub(S_RegisterCards);
			close;
		case 2:
			callsub(S_ViewProgress);
			close;
		case 3:
			callsub(S_ExploreCollection);
			close;
		case 4:
			callsub(S_ViewMissingCards);
			close;
		default:
			mes "Que el Archivo te guarde en sus memorias, aventurero.";
			close;
	}

// Subroutine: Register cards from inventory
S_RegisterCards:
	.@cat_count = getarraysize(.cat_codes$);
	for (.@k = 0; .@k < .@cat_count; .@k++) .@new_cat[.@k] = 0;
	.@total_new = 0;
	getinventorylist;
	for (.@i = 0; .@i < @inventorylist_count; .@i++) {
		.@item_id = @inventorylist_id[.@i];
		.@type = getiteminfo(.@item_id, 2);
		if (.@type == 6) { // IT_CARD
			.@cat$ = getd(".card_cat_" + .@item_id + "$");
			if (.@cat$ == "") .@cat$ = "N/A";
			else {
				.@seen_var$ = "#CARD_SEEN_" + .@item_id;
				.@current_value = getd(.@seen_var$);
				if (.@current_value == 0) {
					setd(.@seen_var$, 1);
					setd("#CARD_CT_" + .@cat$, getd("#CARD_CT_" + .@cat$) + 1);
					// Use direct O(1) lookup instead of loop
					.@idx = getd(".cat_idx_" + .@cat$ + "$");
					.@new_cat[.@idx]++;
					.@total_new++;
				}
			}
		}
	}

	if (.@total_new == 0) {
		mes .npc_name$;
		mes "Tu coleccion ya esta documentada. No hay nuevas cartas que registrar.";
	} else {
		mes .npc_name$;
		mes "Revision completada exitosamente.";
		mes "Cartas nuevas documentadas: " + .@total_new;
		for (.@k = 0; .@k < .@cat_count; .@k++) {
			if (.@new_cat[.@k] > 0) {
				mes "  " + .cat_codes$[.@k] + ": " + .@new_cat[.@k];
			}
		}
	}
	return;

// Subroutine: View progress per category (counts only)
S_ViewProgress:
	.@cat_count = getarraysize(.cat_codes$);
	
	// Calculate total progress
	.@total_obtained = 0;
	.@total_possible = 0;
	for (.@k = 0; .@k < .@cat_count; .@k++) {
		.@code$ = .cat_codes$[.@k];
		.@cnt = getd("#CARD_CT_" + .@code$);
		.@total = .cat_total[.@k];
		.@total_obtained += .@cnt;
		.@total_possible += .@total;
	}
	
	.@total_pct = 0;
	if (.@total_possible > 0) {
		.@total_pct = (.@total_obtained * 100) / .@total_possible;
	}
	
	mes .npc_name$;
	mes "Tu progreso en el Archivo Arcano.";
	mes "";
	mes "Has registrado un total de " + .@total_obtained + " cartas, y segun nuestros registros, en el mundo hay " + .@total_possible + " de ellas. Has encontrado un " + .@total_pct + "% de todas las cartas existentes.";
	next;
	
	mes .npc_name$;
	mes "Detalle por categoria:";
	mes "";
	for (.@k = 0; .@k < .@cat_count; .@k++) {
		.@code$ = .cat_codes$[.@k];
		.@cnt = getd("#CARD_CT_" + .@code$);
		.@total = .cat_total[.@k];
		.@pct = 0;
		if (.@total > 0) {
			.@pct = (.@cnt * 100) / .@total;
		}
		mes .@code$ + ": " + .@cnt + "/" + .@total + " (" + .@pct + "%)";
	}
	return;

// Subroutine: Explore collection - show obtained cards directly
S_ExploreCollection:
	mes .npc_name$;
	mes "Que categoria deseas explorar?";
	mes	"A-Z, BOSS, MVP";
	mes "";
	input .@input_cat$;
	.@input_cat$ = strtoupper(.@input_cat$);
	
	// Validate category
	.@cat_count = getarraysize(.cat_codes$);
	.@found = 0;
	.@cat_idx = -1;
	for (.@k = 0; .@k < .@cat_count; .@k++) {
		if (.cat_codes$[.@k] == .@input_cat$) {
			.@found = 1;
			.@cat_idx = .@k;
			break;
		}
	}
	
	if (.@found == 0) {
		mes "Esa categoria no existe en nuestros registros.";
		return;
	}
	
	.@arr_name$ = ".card_arr_" + .@input_cat$;
	.@total_in_cat = getarraysize(getd(.@arr_name$));
	
	// Show obtained cards directly
	callsub(S_ViewObtained, .@input_cat$, .@arr_name$, .@total_in_cat);
	return;

// Subroutine: View missing cards - select category and show directly
S_ViewMissingCards:
	mes .npc_name$;
	mes "Que categoria deseas revisar?";
	mes "A-Z, BOSS, MVP";
	mes "";
	input .@input_cat$;
	.@input_cat$ = strtoupper(.@input_cat$);
	
	// Validate category
	.@cat_count = getarraysize(.cat_codes$);
	.@found = 0;
	.@cat_idx = -1;
	for (.@k = 0; .@k < .@cat_count; .@k++) {
		if (.cat_codes$[.@k] == .@input_cat$) {
			.@found = 1;
			.@cat_idx = .@k;
			break;
		}
	}
	
	if (.@found == 0) {
		mes "Esa categoria no existe en nuestros registros.";
		return;
	}
	
	.@arr_name$ = ".card_arr_" + .@input_cat$;
	.@total_in_cat = getarraysize(getd(.@arr_name$));
	
	// Show missing cards directly
	callsub(S_ViewMissing, .@input_cat$, .@arr_name$, .@total_in_cat);
	return;

// Subroutine: View obtained cards in category
S_ViewObtained:
	.@cat$ = getarg(0);
	.@arr_name$ = getarg(1);
	.@total = getarg(2);
	mes "Cartas Obtenidas en la Categoria " + .@cat$;
	mes "";
	
	.@count = 0;
	for (.@i = 0; .@i < .@total; .@i++) {
		.@card_id = getd(.@arr_name$ + "[" + .@i + "]");
		if (getd("#CARD_SEEN_" + .@card_id) == 1) {
			.@count++;
			mes " - " + getitemname(.@card_id);
		}
	}
	
	if (.@count == 0) {
		mes "Aun no has documentado ninguna carta de esta categoria.";
	}
	
	mes "";
	mes "Total documentadas: " + .@count;
	return;

// Subroutine: View missing cards in category
S_ViewMissing:
	.@cat$ = getarg(0);
	.@arr_name$ = getarg(1);
	.@total = getarg(2);
	mes "Cartas Faltantes - Categoria " + .@cat$;
	mes "";
	
	.@count = 0;
	for (.@i = 0; .@i < .@total; .@i++) {
		.@card_id = getd(.@arr_name$ + "[" + .@i + "]");
		if (getd("#CARD_SEEN_" + .@card_id) == 0) {
			.@count++;
			mes " - " + getitemname(.@card_id);
		}
	}
	
	if (.@count == 0) {
		mes "Has completado esta categoria! Excelente trabajo, aventurero.";
	}
	
	mes "";
	mes "Total faltantes: " + .@count;
	return;

OnInit:
	.npc_name$ = "[ Archivista de Cartas ]";
	// Category list
	setarray .cat_codes$, "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","Y","Z","BOSS","MVP";
	
	// Build category-to-index mapping for O(1) lookups
	.@cat_count = getarraysize(.cat_codes$);
	for (.@i = 0; .@i < .@cat_count; .@i++) {
		setd(".cat_idx_" + .cat_codes$[.@i] + "$", .@i);
	}

	setarray .card_arr_A, 4013,4032,4043,4062,4075,4094,4114,4138,4234,4240,4242,4244,4245,4246,4247,4248,4249,4252,4253,4344,4347,4371,4387,4400,4401,4402,4409,4443,4464,4473,4513,4515,4567,4596,4629,31022;
	setarray .card_arr_B, 4074,4379,4119,4129,4212,4213,4214,4215,4233,4320,4327,4356,4390,4438,4450,4466,4472,4518,4519,4582,4626,4627;
	setarray .card_arr_C, 4009,4015,4040,4041,4061,4063,4153,4202,4229,4235,4284,4285,4288,4289,4293,4296,4297,4298,4299,4373,4447,4448,4452,4475,4516,4517,4568,4569,4595,27182,27361;
	setarray .card_arr_D, 4004,4023,4056,4069,4082,4098,4122,4125,4133,4170,4173,4176,4177,4178,4180,4181,4182,4272,4370,4385,4388,4421,4444,4449,4458,4506;
	setarray .card_arr_E, 4052,4070,4118,4141,4217,4251,4258,4267,4279,4346,4349,4360,4410,4577,4583,4659;
	setarray .card_arr_F, 4002,4160,4020,4080,4088,4158,4312,4316,4319,4380,4381,4405,4439,4570,4607;
	setarray .card_arr_G, 4060,4072,4378,4087,4110,4149,4150,4151,4152,4155,4157,4161,4162,4164,4165,4270,4271,4278,4280,4283,4323,4355,4377,4418,4508,4571;
	setarray .card_arr_H, 4019,4035,4045,4081,4103,4115,4321,4322,4325,4328,4331,4345,4362,4413,4437,4453,4467,4477;
	setarray .card_arr_I, 4116,4231,4239,4268,4269,4412,4417,4433;
	setarray .card_arr_J, 4109,4139,4474,4265,4589;
	setarray .card_arr_K, 4027,4065,4091,4136,4140,4286,4287,4291,4292,4295,4301,4307,4351,4366,4434;
	setarray .card_arr_L, 4006,4184,4188,4191,4193,4195,4445,4459,4511,4579,4597,4598,4599,4600,4663;
	setarray .card_arr_M, 4030,4036,4046,4055,4057,4067,4076,4079,4084,4090,4095,4097,4105,4106,4108,4112,4113,4124,4126,4196,4199,4200,4201,4204,4205,4206,4208,4317,4339,4341,4343,4364,4420,4432,4510,4584,4585,4593;
	setarray .card_arr_N, 4127,4159,4166,4167,4334,4382,4383,4469,4470,4628;
	setarray .card_arr_O, 4066,4071,4085,4093,4255,4256,4338,4375;
	setarray .card_arr_P, 4001,4003,4005,4007,4008,4011,4024,4031,4033,4048,4073,4077,4099,4120,4175,4309,4310,4311,4313,4314,4315,4329,4335,4337,4389,4461,4465,4468,4476,4512,4514,4523,4594;
	setarray .card_arr_Q, 4294;
	setarray .card_arr_R, 4014,4021,4083,4104,4154,4185,4186,4187,4192,4194,4350,4353,4422,4436,4460,4531,4572,4581,27352;
	setarray .card_arr_S, 4017,4022,4025,4037,4039,4042,4044,4068,4078,4086,4089,4092,4100,4101,4111,4117,4156,4216,4218,4219,4220,4221,4222,4223,4224,4225,4226,4227,4228,4230,4273,4326,4358,4368,4404,4414,4415,4416,4424,4505,4521,4522,4530,4575;
	setarray .card_arr_T, 4012,4016,4026,4028,4050,4058,4172,4282,4304,4308,4340,4442,4573,4586,4587,4630;
	setarray .card_arr_U, 4336;
	setarray .card_arr_V, 4049,4053,4107,4209,4211,4333,4369,4411;
	setarray .card_arr_W, 4010,4029,4034,4102,4189,4190,4210,4232,4257,4259,4260,4261,4264,4303,4332,4348,4558,4588;
	setarray .card_arr_Y, 4051;
	setarray .card_arr_Z, 4038,4064,4096,4274,4275,4277,4281,4435;
	setarray .card_arr_BOSS, 4047,4054,4130,4147,4163,4169,4171,4174,4179,4183,4197,4198,4203,4207,4237,4238,4241,4254,4290,4300,4306,4354,4384,4391,4392,4393,4394,4395,4396,4397,4398,4406,4423,4426,4427,4428,4429,4431,4440,4451,4457,4462,4463,4509,4520,4524,4526,4527,4528,4529,4532,4533,4534,4560,4561,4562,4563,4564,4565,4566,4590,4591,4605,4606,4610,4631,4632;
	setarray .card_arr_MVP, 4121,4128,4131,4132,4134,4135,4137,4142,4143,4144,4145,4146,4147,4148,4168,4236,4263,4276,4302,4305,4318,4324,4330,4342,4352,4357,4359,4361,4363,4365,4367,4372,4374,4376,4386,4399,4403,4407,4408,4419,4425,4430,4441,4456,4507,4525,4574,4576,4578,4580,4592,4601,4603,4625,27164;
	
	// Calculate totals dynamically from card arrays
	for (.@i = 0; .@i < .@cat_count; .@i++) {
		.@arr_name$ = ".card_arr_" + .cat_codes$[.@i];
		.cat_total[.@i] = getarraysize(getd(.@arr_name$));
	}
	
	// Build card-to-category mapping dynamically from card arrays
	// This way, any card change only needs to be made in the card_arr_X[] array
	.@cat_count = getarraysize(.cat_codes$);
	for (.@cat_idx = 0; .@cat_idx < .@cat_count; .@cat_idx++) {
		.@cat$ = .cat_codes$[.@cat_idx];
		.@arr_name$ = ".card_arr_" + .@cat$;
		.@arr_size = getarraysize(getd(.@arr_name$));
		for (.@card_idx = 0; .@card_idx < .@arr_size; .@card_idx++) {
			.@card_id = getd(.@arr_name$ + "[" + .@card_idx + "]");
			setd(".card_cat_" + .@card_id + "$", .@cat$);
		}
	}
	end;

}

// Duplicates
//============================================================
geffen,158,40,1	duplicate(Card Collector)	Card Collector#gef	1_M_SIGNALCHE
prontera,123,98,3	duplicate(Card Collector)	Card Collector#prt	4_F_ALCHE